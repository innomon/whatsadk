# WhatsApp OAuth Specification (Ed25519 / EdDSA JWT)

## 1. Overview
This specification defines a decentralized authentication flow where the **WhatsApp Gateway** acts as an Identity Provider (IdP). It allows a pure client-side **Single Page Application (SPA)** to obtain a cryptographically bound JWT that proves the user's control over a specific WhatsApp number.

The system uses **Ed25519** key pairs and **EdDSA-signed JWTs** (`golang-jwt/jwt/v5`) for compact tokens suitable for WhatsApp deep-link delivery.

## 2. Actors
- **Chat User:** The person using the SPA and WhatsApp.
- **Chat Client (SPA):** A web application (`a2ui-chat-ts`) that needs to authenticate the user.
- **WhatsApp Gateway:** This project (`whatsadk`), acting as the Auth Provider.
- **ADK Server:** The resource server (`adk-cloud-proxy`) that verifies the JWT.

## 3. Cryptographic Foundation
- **Gateway Identity:** An Ed25519 key pair. The private key (seed) is stored securely on the gateway. The public key is shared with the ADK server for JWT verification.
- **User Identity:** An ephemeral Ed25519 key pair generated by the SPA in browser storage. The public key is sent to the gateway during the auth request.
- **Token:** A standard JWT (compact serialization) signed with Ed25519 (`alg: EdDSA`). Ed25519 signatures are 64 bytes, producing tokens of ~300–400 characters — well within WhatsApp's URL limits.

## 4. Public Key Distribution
- The Gateway's Ed25519 **public key** must be provided to the ADK server out-of-band (e.g., via environment variable `OAUTH_PUBLIC_KEY` or a shared secrets file).
- The SPA does **not** verify JWTs directly; it only stores and forwards them.

## 5. The "Deep-Link" Flow (Primary)

1. **Key Generation:**
   - SPA generates a new Ed25519 key pair in browser storage (e.g., using the `jose` JS library).
   - SPA generates a random `nonce` (16+ bytes, base64url-encoded).

2. **Authorization Request:**
   - SPA displays a "Login with WhatsApp" button with a deep link:
     `https://wa.me/<gateway_number>?text=AUTH%20<UserPubKey>%20<nonce>`
   - Note: spaces must be URL-encoded as `%20`.
   - `<UserPubKey>` is the base64url-encoded Ed25519 public key.
   - User clicks and sends the message via WhatsApp.

3. **Gateway Verification:**
   - Gateway receives the message from `<SenderPhone>`.
   - Gateway parses the message with pattern: `^AUTH\s+([A-Za-z0-9_-]{43}=?)\s+([A-Za-z0-9_-]{16,})$`
   - Gateway validates:
     - `<UserPubKey>` is a valid base64url-encoded 32-byte Ed25519 public key.
     - `<SenderPhone>` is not rate-limited (max 5 AUTH requests per phone per hour).
   - Gateway creates a standard JWT with EdDSA signing:
     - `alg`: `EdDSA`
     - `sub`: `<SenderPhone>` (Subject — the authenticated phone number)
     - `iss`: Gateway identifier (e.g., `"whatsadk-gateway"`)
     - `aud`: ADK server identifier (e.g., `"adk-cloud-proxy"`)
     - `iat`: Current time
     - `exp`: Configurable (default: 24 hours)
     - `nonce`: The nonce from the auth request
     - `pubkey`: `<UserPubKey>` (binds token to the SPA's key pair)

4. **Token Delivery:**
   - Gateway constructs a redirect URL back to the SPA:
     `<SPA_Base_URL>/auth#token=<JWT>&nonce=<nonce>`
   - Gateway sends this link to the user via WhatsApp reply.
   - Total URL length is typically ~420 characters (well under WhatsApp's ~2048 char limit).

5. **Client Activation:**
   - User clicks the link in WhatsApp.
   - SPA parses the JWT and nonce from the URL fragment (fragment is not sent to server).
   - SPA verifies the `nonce` matches the one stored in local storage.
   - SPA stores the JWT in local storage.

6. **Resource Access:**
   - SPA sends the JWT in the `Authorization: Bearer <JWT>` header to the ADK Server.
   - ADK Server verifies the JWT signature using the Gateway's Ed25519 public key.
   - ADK Server extracts `sub` (phone number) for user identification and routing.

## 6. JWT Claims Reference

```json
{
  "alg": "EdDSA",
  "typ": "JWT"
}
.
{
  "sub": "919876543210",
  "iss": "whatsadk-gateway",
  "aud": "adk-cloud-proxy",
  "iat": 1700000000,
  "exp": 1700086400,
  "nonce": "a1b2c3d4e5f6g7h8",
  "pubkey": "base64url-encoded-ed25519-public-key"
}
```

## 7. Security Considerations
- **Compact Tokens:** EdDSA JWTs are ~300–400 characters vs ~600–800 for NATS JWTs, avoiding WhatsApp URL truncation.
- **Binding:** The JWT contains the SPA's public key (`pubkey` claim). The ADK server can optionally require a signature challenge to prove possession of the corresponding private key.
- **Phishing / CSRF:** The nonce ties the auth response to the originating SPA instance.
- **Phone Spoofing:** WhatsApp's E2E encryption and verified sender identity ensure the phone number is authentic.
- **Rate Limiting:** The gateway enforces rate limits on AUTH requests per phone number to prevent abuse and excessive WhatsApp API message costs.
- **Token Expiry:** Default 24-hour expiry balances usability (user doesn't re-auth constantly) with security. For higher-security deployments, reduce to 1–4 hours.
- **No Token Revocation (v1):** Issued JWTs cannot be revoked before expiry. Mitigate with shorter TTLs if needed. A blocklist mechanism can be added in a future version.
- **URL Fragment:** The token is delivered in the URL fragment (`#`), which is never sent to the server in HTTP requests, reducing exposure.
