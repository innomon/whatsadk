# WhatsApp OAuth Specification (NATS NKeys + JWT)

## 1. Overview
This specification defines a decentralized authentication flow where the **WhatsApp Gateway** acts as an Identity Provider (IdP). It allows a pure client-side **Single Page Application (SPA)** to obtain a cryptographically bound JWT that proves the user's control over a specific WhatsApp number.

The system uses **Ed25519** signatures via **NATS NKeys** and **NATS JWTs** for high security and performance.

## 2. Actors
- **Chat User:** The person using the SPA and WhatsApp.
- **Chat Client (SPA):** A web application that needs to authenticate the user.
- **WhatsApp Gateway:** This project, acting as the Auth Provider.
- **ADK Server:** The resource server that verifies the JWT.

## 3. Cryptographic Foundation
- **Gateway Identity:** An "Account" NKey (Ed25519). Public key starts with `A`.
- **User Identity:** An ephemeral "User" NKey (Ed25519) generated by the SPA. Public key starts with `U`.
- **Token:** A NATS User JWT signed by the Gateway's Account Key.

## 4. The "Deep-Link" Flow (Primary)

1. **Key Generation:**
   - SPA generates a new Ed25519 key pair (User NKey) in browser storage.
   - SPA generates a random `nonce`.

2. **Authorization Request:**
   - SPA displays a "Login with WhatsApp" button with a deep link:
     `https://wa.me/<gateway_number>?text=AUTH <UserPubKey> <nonce>`
   - User clicks and sends the message.

3. **Gateway Verification:**
   - Gateway receives the message from `<SenderPhone>`.
   - Gateway verifies `<SenderPhone>` is not blacklisted.
   - Gateway creates a NATS User JWT:
     - `sub`: `<SenderPhone>` (Subject)
     - `iss`: Gateway Account Public Key (Issuer)
     - `name`: WhatsApp User Identity
     - `nats`: { `pubkey`: `<UserPubKey>`, `issuer_account`: `<AccountPubKey>` }
     - `iat`: Current time
     - `exp`: 24 hours (configurable)

4. **Token Delivery:**
   - Gateway constructs a redirect URL back to the SPA:
     `<SPA_Base_URL>/auth#token=<JWT>&nonce=<nonce>`
   - Gateway sends this link to the user via WhatsApp reply.

5. **Client Activation:**
   - User clicks the link in WhatsApp.
   - SPA parses the JWT and nonce from the URL fragment.
   - SPA verifies the `nonce` matches the one stored in local storage.
   - SPA stores the JWT.

6. **Resource Access:**
   - SPA sends the JWT in the `Authorization: Bearer <JWT>` header to the ADK Server.
   - ADK Server verifies the JWT signature using the Gateway's Account Public Key.


## 5. Security Considerations
- **Binding:** The JWT is bound to the SPA's public key. Even if intercepted, an attacker cannot use the JWT without the SPA's private key (if the ADK server requires a signature challenge).
- **Phishing:** The deep link includes a nonce to prevent CSRF and ensure the auth flow was initiated by the current SPA instance.
- **Phone Spoofing:** WhatsApp's E2E encryption and verified sender identity ensure the phone number is authentic.
